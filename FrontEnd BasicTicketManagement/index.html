<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Ticket Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Basic Ticket Management System</h1>

        <div id="auth-section">
            <h2>Login</h2>
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
            <p id="login-message" class="error-message"></p>
        </div>

        <div id="app-section" style="display: none;">
            <p>Welcome, <span id="current-user"></span>! (<span id="current-role"></span>)</p>
            <button id="logout-button">Logout</button>

            <div id="engineer-section" style="display: none;">
                <h2>Engineer Dashboard</h2>
                <h3>Register New Customer</h3>
                <form id="register-customer-form">
                    <input type="text" id="new-customer-username" placeholder="Customer Username" required>
                    <input type="password" id="new-customer-password" placeholder="Customer Password" required>
                    <button type="submit">Register Customer</button>
                </form>
                <p id="register-customer-message" class="message"></p>

                <h3>All Tickets (Engineer View)</h3>
                <ul id="engineer-tickets-list"></ul>

                <h3>All Customers</h3>
                <ul id="customer-list"></ul>
            </div>

            <div id="customer-section" style="display: none;">
                <h2>Customer Dashboard</h2>
                <h3>Create New Ticket</h3>
                <form id="create-ticket-form">
                    <textarea id="ticket-description" placeholder="Ticket Description" required></textarea>
                    <button type="submit">Create Ticket</button>
                </form>
                <p id="create-ticket-message" class="message"></p>

                <h3>My Tickets (Customer View)</h3>
                <ul id="customer-tickets-list"></ul>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';

        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const logoutButton = document.getElementById('logout-button');
        const currentUserSpan = document.getElementById('current-user');
        const currentRoleSpan = document.getElementById('current-role');

        const engineerSection = document.getElementById('engineer-section');
        const registerCustomerForm = document.getElementById('register-customer-form');
        const registerCustomerMessage = document.getElementById('register-customer-message');
        const engineerTicketsList = document.getElementById('engineer-tickets-list');
        const customerList = document.getElementById('customer-list');

        const customerSection = document.getElementById('customer-section');
        const createTicketForm = document.getElementById('create-ticket-form');
        const createTicketMessage = document.getElementById('create-ticket-message');
        const customerTicketsList = document.getElementById('customer-tickets-list');

        let loggedInUser = null;
        let loggedInRole = null;

        // Function to show/hide sections based on login status and role
        function updateUI() {
            if (loggedInUser) {
                authSection.style.display = 'none';
                appSection.style.display = 'block';
                currentUserSpan.textContent = loggedInUser;
                currentRoleSpan.textContent = loggedInRole;

                if (loggedInRole === 'ENGINEER') {
                    engineerSection.style.display = 'block';
                    customerSection.style.display = 'none';
                    fetchCustomers();
                    fetchEngineerTickets();
                } else if (loggedInRole === 'CUSTOMER') {
                    engineerSection.style.display = 'none';
                    customerSection.style.display = 'block';
                    fetchCustomerTickets();
                }
            } else {
                authSection.style.display = 'block';
                appSection.style.display = 'none';
                engineerSection.style.display = 'none';
                customerSection.style.display = 'none';
                loginMessage.textContent = '';
                registerCustomerMessage.textContent = '';
                createTicketMessage.textContent = '';
            }
        }

        // --- Authentication Functions ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                if (response.ok) {
                    const data = await response.json(); // Read the JSON response for the message
                    // For session-based security, the server sets a session cookie
                    // No explicit token handling needed on the client side for subsequent requests

                    // Fetch user details to determine role after successful login
                    const userDetailsResponse = await fetch(`${API_BASE_URL}/auth/me`);
                    if (userDetailsResponse.ok) {
                        const userDetails = await userDetailsResponse.json();
                        loggedInUser = userDetails.username;
                        loggedInRole = userDetails.role;
                        loginMessage.textContent = data.message;
                        loginMessage.style.color = 'green';
                        updateUI();
                    } else {
                        loginMessage.textContent = 'Login successful, but failed to fetch user details.';
                        loginMessage.style.color = 'orange';
                        loggedInUser = username; // Fallback
                        loggedInRole = 'UNKNOWN'; // Fallback
                        updateUI();
                    }

                } else {
                    const errorData = await response.json();
                    loginMessage.textContent = errorData.error || 'Login failed.';
                    loginMessage.style.color = 'red';
                    loggedInUser = null;
                    loggedInRole = null;
                    updateUI();
                }
            } catch (error) {
                console.error('Login error:', error);
                loginMessage.textContent = 'Network error during login. Please try again.';
                loginMessage.style.color = 'red';
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // Not strictly needed for logout but good practice
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    loggedInUser = null;
                    loggedInRole = null;
                    updateUI();
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Logout failed.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Network error during logout. Please try again.');
            }
        });


        // --- Engineer Functions ---
        registerCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = registerCustomerForm['new-customer-username'].value;
            const password = registerCustomerForm['new-customer-password'].value;

            try {
                const response = await fetch(`${API_BASE_URL}/customers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password, role: 'CUSTOMER' }), // Role set on backend
                });

                if (response.ok) {
                    registerCustomerMessage.textContent = `Customer ${username} registered successfully!`;
                    registerCustomerMessage.style.color = 'green';
                    registerCustomerForm.reset();
                    fetchCustomers(); // Refresh customer list
                } else {
                    const errorData = await response.json(); // Assuming JSON error response
                    registerCustomerMessage.textContent = errorData.error || 'Failed to register customer.';
                    registerCustomerMessage.style.color = 'red';
                }
            } catch (error) {
                console.error('Register customer error:', error);
                registerCustomerMessage.textContent = 'Network error during customer registration.';
                registerCustomerMessage.style.color = 'red';
            }
        });

        async function fetchCustomers() {
            try {
                const response = await fetch(`${API_BASE_URL}/customers`);
                if (response.ok) {
                    const customers = await response.json();
                    customerList.innerHTML = '';
                    if (customers.length === 0) {
                        customerList.innerHTML = '<li>No customers found.</li>';
                        return;
                    }
                    customers.forEach(customer => {
                        const li = document.createElement('li');
                        li.textContent = `ID: ${customer.id}, Username: ${customer.username}`;
                        customerList.appendChild(li);
                    });
                } else {
                    customerList.innerHTML = '<li>Failed to load customers.</li>';
                }
            } catch (error) {
                console.error('Fetch customers error:', error);
                customerList.innerHTML = '<li>Error loading customers.</li>';
            }
        }

        async function fetchEngineerTickets() {
            try {
                const response = await fetch(`${API_BASE_URL}/tickets`);
                if (response.ok) {
                    const tickets = await response.json();
                    engineerTicketsList.innerHTML = '';
                    if (tickets.length === 0) {
                        engineerTicketsList.innerHTML = '<li>No tickets found.</li>';
                        return;
                    }
                    tickets.forEach(ticket => {
                        const li = document.createElement('li');
                        let acknowledgedBy = ticket.acknowledgedBy ? ` (Acknowledged by: ${ticket.acknowledgedBy.username})` : '';
                        li.innerHTML = `
                            Ticket ID: ${ticket.id},
                            Description: ${ticket.description},
                            Status: <span class="status-${ticket.status.toLowerCase()}">${ticket.status}</span>,
                            Created By: ${ticket.createdBy.username} ${acknowledgedBy}
                            <button onclick="acknowledgeTicket(${ticket.id})">Acknowledge</button>
                            <button onclick="updateTicketStatus(${ticket.id}, 'IN_PROGRESS')">In Progress</button>
                            <button onclick="updateTicketStatus(${ticket.id}, 'CLOSED')">Close</button>
                        `;
                        engineerTicketsList.appendChild(li);
                    });
                } else {
                    engineerTicketsList.innerHTML = '<li>Failed to load tickets.</li>';
                }
            } catch (error) {
                console.error('Fetch engineer tickets error:', error);
                engineerTicketsList.innerHTML = '<li>Error loading tickets.</li>';
            }
        }

        async function acknowledgeTicket(ticketId) {
            // In a real app, you'd get the engineerId from the logged-in user context
            // For this example, assuming the logged-in user is the engineer performing the action
            const engineerId = prompt("Enter Engineer ID to acknowledge (e.g., your ID if logged in as engineer):");
            if (!engineerId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/tickets/${ticketId}/acknowledge/${engineerId}`, {
                    method: 'PUT',
                });
                if (response.ok) {
                    alert('Ticket acknowledged successfully!');
                    fetchEngineerTickets();
                } else {
                    const errorData = await response.json();
                    alert('Failed to acknowledge ticket: ' + (errorData.error || response.statusText));
                }
            } catch (error) {
                console.error('Acknowledge ticket error:', error);
                alert('Network error during ticket acknowledgment.');
            }
        }

        async function updateTicketStatus(ticketId, newStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/tickets/${ticketId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus }),
                });
                if (response.ok) {
                    alert(`Ticket status updated to ${newStatus}!`);
                    fetchEngineerTickets();
                } else {
                    const errorData = await response.json();
                    alert('Failed to update ticket status: ' + (errorData.error || response.statusText));
                }
            } catch (error) {
                console.error('Update ticket status error:', error);
                alert('Network error during ticket status update.');
            }
        }


        // --- Customer Functions ---
        createTicketForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = createTicketForm['ticket-description'].value;

            // In a real app, you would get the customerId from the authenticated user.
            // For simplicity, we'll assume the customer ID is available or fetched.
            // You might need an /auth/me endpoint that returns user details including ID.
            // For now, let's prompt or hardcode a dummy for demonstration.
            const customerId = prompt("Enter your Customer ID (e.g., your ID if logged in as customer):");
            if (!customerId) {
                createTicketMessage.textContent = 'Customer ID is required.';
                createTicketMessage.style.color = 'red';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/tickets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ customerId: parseInt(customerId), description }),
                });

                if (response.ok) {
                    createTicketMessage.textContent = 'Ticket created successfully!';
                    createTicketMessage.style.color = 'green';
                    createTicketForm.reset();
                    fetchCustomerTickets(); // Refresh customer's tickets
                } else {
                    const errorData = await response.json();
                    createTicketMessage.textContent = errorData.error || 'Failed to create ticket.';
                    createTicketMessage.style.color = 'red';
                }
            } catch (error) {
                console.error('Create ticket error:', error);
                createTicketMessage.textContent = 'Network error during ticket creation.';
                createTicketMessage.style.color = 'red';
            }
        });

        async function fetchCustomerTickets() {
            try {
                // In a real application, you would filter tickets by the logged-in customer's ID
                // The backend currently fetches all tickets.
                // For this example, we'll fetch all and assume the customer only cares about their own.
                // A better approach would be a /tickets/myTickets endpoint or filtering on the backend.
                const response = await fetch(`${API_BASE_URL}/tickets`);
                if (response.ok) {
                    const allTickets = await response.json();
                    // Filter tickets created by the current customer
                    // This requires the /auth/me endpoint to provide the customer's ID, or another mechanism
                    // For this basic example, we'll just show all tickets for now, assuming a customer
                    // might see all if the backend isn't filtering.
                    // A more accurate client-side filter would look like:
                    // const customerId = // get loggedInCustomerId from /auth/me or session
                    // const tickets = allTickets.filter(ticket => ticket.createdBy.id === customerId);

                    customerTicketsList.innerHTML = '';
                    if (allTickets.length === 0) {
                        customerTicketsList.innerHTML = '<li>No tickets created yet.</li>';
                        return;
                    }
                    allTickets.forEach(ticket => {
                        const li = document.createElement('li');
                        let acknowledgedBy = ticket.acknowledgedBy ? ` (Acknowledged by: ${ticket.acknowledgedBy.username})` : '';
                        li.innerHTML = `
                            Ticket ID: ${ticket.id},
                            Description: ${ticket.description},
                            Status: <span class="status-${ticket.status.toLowerCase()}">${ticket.status}</span>
                            ${acknowledgedBy}
                        `;
                        customerTicketsList.appendChild(li);
                    });
                } else {
                    customerTicketsList.innerHTML = '<li>Failed to load your tickets.</li>';
                }
            } catch (error) {
                console.error('Fetch customer tickets error:', error);
                customerTicketsList.innerHTML = '<li>Error loading your tickets.</li>';
            }
        }


        // Initial UI update on page load
        updateUI();

        // Optional: Check if already logged in on page load (e.g., if session cookie exists)
        // This requires an endpoint that returns the current user's details without requiring re-login.
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`);
                if (response.ok) {
                    const userDetails = await response.json();
                    loggedInUser = userDetails.username;
                    loggedInRole = userDetails.role;
                    updateUI();
                } else {
                    loggedInUser = null;
                    loggedInRole = null;
                    updateUI();
                }
            } catch (error) {
                console.error('Error checking login status:', error);
                loggedInUser = null;
                loggedInRole = null;
                updateUI();
            }
        }
        checkLoginStatus(); // Call on page load
    </script>
</body>
</html>